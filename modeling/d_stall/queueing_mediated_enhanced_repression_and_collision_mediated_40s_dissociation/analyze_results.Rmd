---
title: "Analysis of computational simulations of perturbed d_stall in the queueing-mediated enhanced repression and collision-mediated 40S dissociation models"
author: "`r Sys.info()[['user']]`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  github_document:
    toc: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

# Load libraries
```{r}
library(tidyverse)
library(rasilabRtemplates)
library(viridis)
# disable scientific notation
options(scipen=999)
```

# Read reaction firing data
```{r}
rxn_data <- list.files("output/", pattern = "rxn_list.tsv.gz", full.names = T) %>% 
  enframe() %>% 
  mutate(sim_id = as.integer(str_extract(value, "(?<=model_)\\d+"))) %>% 
  mutate(data = map(value, read_tsv)) %>%
  select(-name, -value) %>% 
  unnest() %>%
  print()
```

# Read simulation time data
```{r}
sim_data <- list.files("output/", pattern = "molecule_type_list.tsv.gz", full.names = T) %>% 
  enframe() %>% 
  mutate(sim_id = as.integer(str_extract(value, "(?<=model_)\\d+"))) %>% 
  mutate(data = map(value, read_tsv)) %>%
  select(-name, -value) %>% 
  unnest() %>% 
  filter(mol_type %in% c("simulated_time", "cpu_time")) %>% 
  spread(mol_type, mol_type_id) %>% 
  print()
```

# Read last reaction time data

```{r}
last_rxn_data <- list.files("output/", pattern = "molecule_type_list.tsv.gz", full.names = T) %>% 
  enframe() %>% 
  mutate(sim_id = as.integer(str_extract(value, "(?<=model_)\\d+"))) %>% 
  mutate(data = map(value, read_tsv)) %>%
  select(-name, -value) %>% 
  unnest() %>% 
  filter(mol_type == "last_rxn_firing_time") %>%
  spread(mol_type, mol_type_id) %>% 
  print()
```

# Check to make sure last reaction fired near end of simulation. 
0 rows output means all simulations' last reactions fired in last 0.1% of simulated time

```{r}
check_rxn <- last_rxn_data %>%
  left_join(sim_data, by = "sim_id") %>%
  mutate(ratio = last_rxn_firing_time / simulated_time) %>%
  filter(ratio < 0.999) %>%
  print()
```

# Read simulation parameters
```{r}
annotations  <- read_tsv('sim.params.tsv') %>%
  mutate(d_stall = x_stall - uorf2_start) %>%
  print()
```

# Calculate protein synthesis rate of main ORF

```{r}
psr_data <- rxn_data %>% 
  mutate(mrna_loc = str_extract(name, "\\d+$")) %>% 
  left_join(annotations %>% select(sim_id, uorf2_stop, orf_stop), by = "sim_id") %>% 
  filter((mrna_loc == orf_stop) & str_detect(name, "terminate")) %>% 
  group_by(sim_id, mrna_loc) %>% 
  summarize(n_firings = sum(n_firings)) %>% 
  left_join(sim_data, by = "sim_id") %>% 
  mutate(psr = n_firings / simulated_time) %>% 
  select(sim_id, mrna_loc, psr) %>% 
  print()
```

# Get only annotations that we want to use for plotting

```{r}
param_data <- annotations %>% 
    select(sim_id, d_stall, k_scan_term_3_hit_80s, k_start_uorf2) %>%
  print()
```

# Combine all processed data into a single table
```{r}
data <- param_data %>% 
  left_join(psr_data, by = "sim_id") %>%
  rename(k_abort = k_scan_term_3_hit_80s) %>% 
  print()
```

# Plot PSR as a function of d_stall and k_abort rates
```{r,fig.width=3.5,fig.height=1.5}
plot_data <- data %>%
  #filter(d_stall %in% c(60, 66, 90, 96)) %>%
  mutate(Model = if_else(k_abort == 0, "queueing-mediated\nenhanced repression", "collision-mediated\n40S dissociation")) %>%
  mutate(psr = psr/max(psr)) %>%
  filter(k_start_uorf2 != 0) %>%
  print()

plot_data %>% 
  ggplot(aes(x = d_stall, y = log2(psr), color = Model, group = Model)) +
  #facet_wrap(~ k_abort + k_start_uorf2 + k_recycle, ncol = 3, labeller = label_both, scales = "free") +
  geom_point() +
  geom_line() +
  scale_color_viridis(discrete = T, end = 0.9) +
  labs(y = "main ORF protein output (log2, s-1)", x = "dstall (nt)") +
  coord_flip()

  ggsave('figures/d_stall_predictions_queueing-mediated_enhanced repression_collision-mediated_40S dissociation.pdf')

```

# Conclusions

 - Varying d_stall in the collision-mediated 40S dissociation model is predicted to not change main ORF protein output very much (~ 2 fold)
 - Varying d_stall in the queueing-mediated enhanced repression model is predicted to change main ORF protein output significantly (~ 8 fold)
 - In both models, 2 clusters of main ORF protein output are predicted: repressed (when a queue can productively form, d_stall / 30 == integer) and high (when a queue cannot productively form, d_stall = 30 != integer), queues can rarely form in the collision-mediated 40S dissociation model since the dissociation rate is only 2/s